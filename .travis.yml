language: generic
dist: bionic
env:
  global:
    - CLI_VERSION=master
  matrix:
    - BOARD="esp32:esp32:heltec_wifi_lora_32_V3"
    - BOARD="CubeCell:CubeCell:CubeCell-Board-V2"

jobs:
  include:
    - stage: system-setup
      before_install:
        - sudo add-apt-repository --yes ppa:nnstreamer/ppa
        - sudo apt-get update
        - sudo apt-get -y install cppcheck
        - python -m pip install pyserial
        - cppcheck --version
        - cppcheck --force --error-exitcode=1 src
        - curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh -s
        - export PATH=$PATH:$PWD/bin/

    - stage: arduino-setup
      before_install:
        - arduino-cli config init
        - arduino-cli config set library.enable_unsafe_install true
        - arduino-cli core update-index --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        - if [[ "$BOARD" =~ "esp32:esp32:" ]]; then
            arduino-cli core install esp32:esp32 --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json;
          fi

    - stage: dependencies-setup
      before_install:
        - rsync -rltv --exclude=.git --exclude=bin ${PWD}/ /tmp/CDP/ && (cd /tmp && zip -r /tmp/cdp.zip CDP) && arduino-cli lib install --zip-path /tmp/cdp.zip
        - |-
          file="library.properties"
          
          function prop {
            PROP_VALUE=`cat $file | grep "${1}" | cut -d'=' -f2`
            echo $PROP_VALUE
          }

          dependsvar=$(prop "depends")

          IFS=$'\n' read -r -d '' -a the_array < <(awk -F',' '{ for( i=1; i<=NF; i++) print $i }' <<<"$dependsvar")

          for i in "${the_array[@]}"
          do
            echo "$i"
            if [[ "$i" == *"github"* ]]; then
              arduino-cli lib install --git-url "$i"
            elif [[ "$i" == *".zip"* ]]; then
              arduino-cli lib install --zip-path "$i"
            else
              arduino-cli lib install "$i"
            fi
          done

    - stage: build
      before_install:
        - buildExampleSketch() { arduino-cli compile -t -b $BOARD $PWD/examples/$1/$2/$2.ino; } 
      script:
        - buildExampleSketch 1.Ducks DuckLink
        - buildExampleSketch 1.Ducks MamaDuck
        - buildExampleSketch 1.Ducks PapaDuck
        - buildExampleSketch 1.Ducks DetectorDuck